name: Coverage Report

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build and generate Tests reports
        run: ./gradlew build

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Calculate Coverage
        id: coverage
        run: |
            set -euo pipefail
            
            # Paths to Jacoco XML reports
            UNIT_XML="build/reports/jacoco/unit/jacoco.xml"
            INTEGRATION_XML="build/reports/jacoco/integration/jacoco.xml"
            COMBINED_XML="build/reports/jacoco/combined/jacoco.xml"
            
            # Function to calculate coverage percentage
            get_coverage() {
              local xml_file="$1"
              cov=$(xmllint --xpath "sum(//counter[@type='LINE']/@covered) div (sum(//counter[@type='LINE']/@covered) + sum(//counter[@type='LINE']/@missed))" "$xml_file")
              echo "$cov * 100" | bc -l | awk '{printf "%.0f", $0}'
            }
            
            # Calculate coverages
            UNIT_COVERAGE=$(get_coverage "$UNIT_XML")
            INTEGRATION_COVERAGE=$(get_coverage "$INTEGRATION_XML")
            COMBINED_COVERAGE=$(get_coverage "$COMBINED_XML")
            
            # Print results
            echo "Unit Test Coverage: ${UNIT_COVERAGE}%"
            echo "Integration Test Coverage: ${INTEGRATION_COVERAGE}%"
            echo "Combined Coverage: ${COMBINED_COVERAGE}%"
            
            # Export for GitHub Actions
            echo "unit_coverage=$UNIT_COVERAGE" >> $GITHUB_OUTPUT
            echo "integration_coverage=$INTEGRATION_COVERAGE" >> $GITHUB_OUTPUT
            echo "combined_coverage=$COMBINED_COVERAGE" >> $GITHUB_OUTPUT

      - name: Find existing comment
        if: github.event_name == 'pull_request'
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "Code Coverage Report"  # or another unique text in your comment
          comment-author: github-actions[bot]

      - name: Add PR Comment with Coverage
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## ğŸ” Code Coverage Report

            | Test Type            | Coverage |
            |----------------------|----------|
            | ğŸ“˜ Unit Tests        | **${{ steps.coverage.outputs.unit_coverage }}%** |
            | ğŸ“— Integration Tests | **${{ steps.coverage.outputs.integration_coverage }}%** |
            | ğŸ“™ Combined          | **${{ steps.coverage.outputs.combined_coverage }}%** |
